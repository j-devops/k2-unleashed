#!/bin/bash
# K2 Unleashed - Command-line tool for K2 Series Klipper enhancements
# Copyright (C) 2025 K2 Unleashed Contributors
#
# This file is part of K2 Unleashed.
#
# K2 Unleashed is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# K2 Unleashed is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with K2 Unleashed.  If not, see <https://www.gnu.org/licenses/>.
#
# https://github.com/j-devops/k2-unleashed

# Read version from VERSION file
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ -f "$SCRIPT_DIR/VERSION" ]; then
    VERSION=$(cat "$SCRIPT_DIR/VERSION")
else
    VERSION="unknown"
fi

SCRIPTS_DIR="$SCRIPT_DIR/scripts"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Show usage
show_usage() {
    echo -e "${BOLD}K2 Unleashed${NC} - Enhanced monitoring and diagnostics for K2 Series"
    echo ""
    echo -e "${BOLD}USAGE:${NC}"
    echo "    k2-unleashed [OPTIONS] <COMMAND> [ARGS]"
    echo ""
    echo -e "${BOLD}COMMANDS:${NC}"
    echo -e "    ${GREEN}status${NC}              Check printer status and feature installation"
    echo -e "    ${GREEN}upgrade${NC}             Deploy/upgrade enhanced features to printer"
    echo -e "    ${GREEN}backup${NC}              Backup current printer configuration"
    echo -e "    ${GREEN}rollback${NC} <ID>       Restore configuration from backup"
    echo -e "    ${GREEN}check${NC}               Run health check diagnostics"
    echo -e "    ${GREEN}logs${NC}                View Klipper logs in real-time"
    echo -e "    ${GREEN}init${NC}                Initialize configuration (.env file)"
    echo ""
    echo -e "${BOLD}OPTIONS:${NC}"
    echo "    -h, --help          Show this help message"
    echo "    -v, --version       Show version information"
    echo "    -q, --quiet         Suppress non-error output"
    echo ""
    echo -e "${BOLD}EXAMPLES:${NC}"
    echo "    k2-unleashed init                    # First-time setup"
    echo "    k2-unleashed status                  # Check printer status"
    echo "    k2-unleashed upgrade                 # Deploy features"
    echo "    k2-unleashed backup                  # Create backup"
    echo "    k2-unleashed rollback 20240115_1430  # Restore backup"
    echo "    k2-unleashed check                   # Run health check"
    echo "    k2-unleashed logs                    # View logs"
    echo ""
    echo -e "${BOLD}CONFIGURATION:${NC}"
    echo "    Config file: .env"
    echo "    Run 'k2-unleashed init' to create from template"
    echo ""
    echo -e "${BOLD}DOCUMENTATION:${NC}"
    echo "    README.md                                  - Overview and installation"
    echo "    specs/BED_LEVELING_GUIDE.md                - Precision bed leveling"
    echo "    specs/FIRMWARE_ERROR_HANDLING_ANALYSIS.md  - Error handling analysis"
    echo "    specs/WEB_DASHBOARD_DESIGN.md              - Dashboard architecture"
    echo "    specs/DIAGNOSTICS_GUIDE.md                 - Diagnostics guide"
    echo "    specs/MONITORING_FIX_SUMMARY.md            - Monitoring fix details"
    echo "    specs/CLI_GUIDE.md                         - CLI usage guide"
    echo ""
    echo -e "${BOLD}SUPPORT:${NC}"
    echo "    GitHub Issues: https://github.com/user/k2-unleashed/issues"
}

# Show version
show_version() {
    echo "k2-unleashed version $VERSION"
}

# Initialize configuration
cmd_init() {
    echo "========================================="
    echo "K2 Unleashed - Initialize Configuration"
    echo "========================================="
    echo ""

    if [ -f "$SCRIPT_DIR/.env" ]; then
        echo -e "${YELLOW}Warning: .env file already exists${NC}"
        read -p "Overwrite? [y/N] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Initialization cancelled."
            return 0
        fi
    fi

    if [ ! -f "$SCRIPT_DIR/.env.example" ]; then
        echo -e "${RED}Error: .env.example not found${NC}"
        return 1
    fi

    cp "$SCRIPT_DIR/.env.example" "$SCRIPT_DIR/.env"
    echo -e "${GREEN}âœ“${NC} Created .env from template"
    echo ""
    echo "Next steps:"
    echo "  1. Edit .env with your printer details:"
    echo "     nano .env"
    echo ""
    echo "  2. Update PRINTER_HOST with your printer's IP"
    echo "  3. Verify other settings (defaults should work)"
    echo ""
    echo "  4. Test connection:"
    echo "     k2-unleashed status"
    echo ""
    echo "  5. Deploy features:"
    echo "     k2-unleashed upgrade"
}

# View logs
cmd_logs() {
    if [ ! -f "$SCRIPT_DIR/.env" ]; then
        echo -e "${RED}Error: .env file not found${NC}"
        echo "Run: k2-unleashed init"
        return 1
    fi

    set -a
    source "$SCRIPT_DIR/.env"
    set +a

    # Build SSH command
    SSH_OPTS="-o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR"

    if [ -n "$PRINTER_PASSWORD" ]; then
        if ! command -v sshpass &> /dev/null; then
            echo -e "${RED}Error: sshpass required for password authentication${NC}"
            return 1
        fi
        ssh_cmd() { sshpass -p "$PRINTER_PASSWORD" ssh $SSH_OPTS -p $PRINTER_PORT ${PRINTER_USER}@${PRINTER_HOST} "$@"; }
    else
        ssh_cmd() { ssh $SSH_OPTS -p $PRINTER_PORT ${PRINTER_USER}@${PRINTER_HOST} "$@"; }
    fi

    echo "========================================="
    echo "K2 Unleashed - Klipper Logs"
    echo "========================================="
    echo ""
    echo "Connecting to ${PRINTER_HOST}..."
    echo "Press Ctrl+C to exit"
    echo ""

    # Try journalctl first, fall back to tail for OpenWrt
    if ssh_cmd "command -v journalctl >/dev/null 2>&1" 2>/dev/null; then
        ssh_cmd "journalctl -u klipper -f"
    else
        # OpenWrt/BusyBox - tail klippy.log (try multiple common locations)
        ssh_cmd "for log in /mnt/UDISK/printer_data/logs/klippy.log /tmp/klippy.log /usr/data/printer_data/logs/klippy.log; do if [ -f \$log ]; then tail -f \$log; exit 0; fi; done; echo 'Log file not found'"
    fi
}

# Parse options
QUIET=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_usage
            exit 0
            ;;
        -v|--version)
            show_version
            exit 0
            ;;
        -q|--quiet)
            QUIET=true
            shift
            ;;
        *)
            break
            ;;
    esac
done

# Get command
COMMAND="$1"
shift || true

# Execute command
case "$COMMAND" in
    status)
        bash "$SCRIPTS_DIR/status.sh" "$@"
        ;;
    upgrade|deploy)
        bash "$SCRIPTS_DIR/deploy.sh" "$@"
        ;;
    backup)
        bash "$SCRIPTS_DIR/backup.sh" "$@"
        ;;
    rollback)
        bash "$SCRIPTS_DIR/rollback.sh" "$@"
        ;;
    check|health)
        bash "$SCRIPTS_DIR/check.sh" "$@"
        ;;
    logs)
        cmd_logs "$@"
        ;;
    init|config|setup)
        cmd_init "$@"
        ;;
    "")
        echo -e "${RED}Error: No command specified${NC}"
        echo ""
        show_usage
        exit 1
        ;;
    *)
        echo -e "${RED}Error: Unknown command '$COMMAND'${NC}"
        echo ""
        show_usage
        exit 1
        ;;
esac
